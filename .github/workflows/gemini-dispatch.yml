name: 'ðŸ”€ Gemini Dispatch'

on:
  pull_request_review_comment:
    types: ['created']
  pull_request_review:
    types: ['submitted']
  pull_request:
    types: ['opened', 'reopened', 'synchronize']
  issue_comment:
    types: ['created']
  issues:
    types: ['opened', 'reopened']

permissions:
  contents: 'read'
  issues: 'write'
  pull-requests: 'write'

jobs:
  dispatch:
    if: github.event.sender.type != 'Bot'
    runs-on: 'ubuntu-latest'
    outputs:
      command: '${{ steps.extract_command.outputs.command }}'
      prompt: '${{ steps.extract_command.outputs.prompt }}'
      additional_context: '${{ steps.extract_command.outputs.additional_context }}'
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Extract command'
        id: 'extract_command'
        uses: 'actions/github-script@v7'
        env:
          EVENT_NAME: '${{ github.event_name }}'
          EVENT_ACTION: '${{ github.event.action }}'
          REQUEST: '${{ github.event.comment.body || github.event.review.body || github.event.issue.body || github.event.pull_request.title }}'
        with:
          script: |
            const eventName = process.env.EVENT_NAME;
            const eventAction = process.env.EVENT_ACTION;
            const request = process.env.REQUEST || '';

            core.setOutput('prompt', request);

            if (eventName === 'pull_request' && eventAction === 'opened') {
              core.setOutput('command', 'review');
            } else if (request.startsWith("@gemini-cli /review")) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.includes("@gemini-cli")) {
              const additionalContext = request.replace(/@gemini-cli/, '').trim();
              core.setOutput('command', 'invoke');
              core.setOutput('additional_context', additionalContext);
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: 'Acknowledge request'
        if: steps.extract_command.outputs.command != 'fallthrough' && steps.extract_command.outputs.command != ''
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– I've received your request and I'm working on it! [Tracking Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

  review:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'review'
    uses: './.github/workflows/gemini-review.yml'
    secrets: inherit
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'

  invoke:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'invoke'
    uses: './.github/workflows/gemini-invoke.yml'
    secrets: inherit
    with:
      prompt: '${{ needs.dispatch.outputs.prompt }}'
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
